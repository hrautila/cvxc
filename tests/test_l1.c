
// Copyright: Harri Rautila, 2021 <harri.rautila@gmail.com>

#include <unistd.h>
#include "cvxc.h"

extern int print_solution(cvxc_solution_t *sol);

/*
 * Penalty function approximation
 *
 *  minimize || P*x + b ||
 *
 *  equal to:
 *
 *   minimize 1*u + 1*w
 *   s.t.
 *      P*x - u + w = -b
 *      u, w >= 0
 *      x \in R^n, u, w \in R^m
 *
 *   min [0, 1, 1] [x, u, w]^T
 *   s.t.
 *     [P, -I, I] [x, u, w]^T = -b
 *
 *     [0, -I, 0] [x, u, w]^T <= 0
 *     [0, 0, -I]
 */

static cvxc_float_t Adata[] = {
     0.1339186081186759, -0.0881009918314384, 1.6744084062537739, 0.7336411072925795,
     0.9975246316020123, -1.2775020810027664, -2.3967152827332074, -0.679280164729211,
    -0.03909131843358723, 0.8935555455208181, -0.017647794589783286, -1.2965569087773203,
    -0.6679805060086351, 0.18170877830799323, 0.831050790340693, -0.5482484713968284,
    -0.6380315026933989, 0.00708853169542829, -0.669853694377588, -0.8277623313869475,
     0.6125000303605203, -0.36758841015776106, -0.28949340911906524, -0.916874670814644,
    -0.5838054587982235, 0.06461529015869494, 0.04674385977341894, -0.7507269786680086,
    -0.14423268736469502, 1.475560796921868, -0.20647897491996936, -0.2606972788752814,
    -0.13821797189084586, -2.5433972170515946, 0.5774185367096882, -0.03610986310676272,
    -0.2261725681592543, 0.7150022171291442, 1.577266886541316, -0.3922738614874117,
     1.1827708557922374, 1.7931136874114746, -0.7313459673059127, -0.6298176812701637,
     2.0706945708030844, -0.9030060074338814, 1.7355455376113267, 1.3830888601267264,
     -0.3753666398769228, -0.30431019951136606, 1.2535712488263888, -0.2738451792472263,
     -0.046329381423941066, 0.7989824701079073, 0.5399558892491029, 0.08585033894586751,
     1.3552912207405383, 0.01385086083133875, 0.7513636950232079, -1.574909178205688,
     -0.23737825305680132, 0.33649059262790887, -0.07959967279201274, -0.5408722422988715,
     -1.3804339427788093, 1.7165518602743903, 0.4181118040001357, 1.524956587446072,
     0.6864763312725167, -0.5885559708574298, 1.3167479093805874, -0.8329841448294092,
     0.7739602973783032, -0.8035154064638703, -0.08543027502251639, 1.4961978952405885,
     0.3977667935192024, 3.338429866867601, 1.8009350263542732, 1.7562786106097308,
     0.6674736596213121, -1.0501681048472389, 0.32937053624566975, 0.4550810384591309,
     -2.347007320481933, -0.6138992374203155, -2.1618005886842244, -1.0013431202321639,
     -0.4622676282608134, -0.8175610613767962, 0.18439203820434547, -0.3949169760268868,
     -1.669557308970819, -0.9451478436250467, 0.0035699934857124204, 1.1557394664082907,
     1.8774313540661332, 0.1121989302880207, 0.18121323774935597, 1.2783044502922614,
     0.5710577756088738, -0.47090772901385863, 0.463358374801393, 2.0173250972925056,
     2.1497048659245386, -0.37108331875332556, -0.7442910145368544, -1.2807238593932446,
     -1.3886645064936156, -0.3824685870686393, 1.4813207889785576, -1.3316687728419714,
     -1.0482820737067198, -0.14377236910685562, 0.1808578192824503, 2.33491952194362,
     0.3516988716731843, 0.37141138723027795, -0.7211061727544363, 1.7267817649091295
};

static cvxc_float_t bdata[] = {
    -0.1818236762405594, 0.7755994405934774, 0.08808840457624972,
    -0.18232958023517903, -0.7114287366314612, -0.199528294382903,
    -0.13064105797206163, 0.1599364341487222, -0.24280771148944036,
    -0.15970990740152718, 0.2223719186579637, 0.23954245510249822,
    0.909090909090909, 0.35105272042044783, 0.39800894064108694
};

int main(int argc, char **argv)
{
    cvxc_matrix_t G, h, A, b, c, c1, P0, U0, W0, I;
    cvxc_problem_t cp;
    cvxc_dimset_t dims;
    int opt;
    cvxc_size_t m, n;
    m = 15;
    n = 8;

    cvxc_solopts_t opts = (cvxc_solopts_t){
        .abstol = 0.0,
        .reltol = 0.0,
        .feastol = 0.0,
        .max_iter = 30,
        .refinement = 0,
        .bits = CVXC_OPROGRESS
    };

    while ((opt = getopt(argc, argv, "N:A:b:")) != -1) {
        switch (opt) {
        case 'N':
            opts.max_iter = atoi(optarg);
            break;
        case 'm':
            m = atoi(optarg);
            break;
        case 'n':
            n = atoi(optarg);
            break;
        default:
            break;
        }
    }

    cvxm_init(&b, m, 1);
    cvxm_init(&A, m, n + 2*m);

    cvxm_view_map(&P0, &A, 0, 0,   m, n);
    cvxm_view_map(&U0, &A, 0, n,   m, m);
    cvxm_view_map(&W0, &A, 0, n+m, m, m);

    int base_test = m == 15 && n == 8;
    if (base_test) {
        cvxc_matrix_t Pt, bt;
        cvxm_map_data(&Pt, m, n, Adata);
        cvxm_map_data(&bt, m, 1, bdata);
        cvxm_copy(&P0, &Pt, 0);
        cvxm_copy(&b,  &bt, 0);
    } else {
        cvxm_set_from(&b, armas_normal);
        cvxm_scale(&b, -1.0/(1.1 * cvxm_amax(&b)), 0);
        cvxm_set_from(&P0, armas_normal);
    }

    // A = [P, -I, I] Ax - u + w = -b

    cvxm_view_diag(&I, &U0, 0);
    cvxm_set_all(&I, -1.0);

    cvxm_view_diag(&I, &W0, 0);
    cvxm_set_all(&I, 1.0);

    // G = [0, -I, 0; 0, 0, -I]
    cvxm_init(&h, 2*m, 1);
    cvxm_init(&G, 2*m, n+2*m);

    cvxm_view_map(&U0, &G, 0, n, m, m);
    cvxm_view_diag(&I, &U0, 0);
    cvxm_set_all(&I, -1.0);

    cvxm_view_map(&W0, &G, m, n+m, m, m);
    cvxm_view_diag(&I, &W0, 0);
    cvxm_set_all(&I, -1.0);

    // c = [0, 1, 1]
    cvxm_init(&c, n+2*m, 1);

    cvxm_view_map(&c1, &c, n, 0, m, 1);
    cvxm_set_all(&c1, 1.0);

    cvxm_view_map(&c1, &c, n+m, 0, m, 1);
    cvxm_set_all(&c1, 1.0);

    dims = (cvxc_dimset_t){.ldim = 2*m};

    if (opts.max_iter == 0)
        return 0;

    cvxc_solution_t solution = {0};

    cvxc_conelp_setup(&cp, &c, &G, &h, &A, &b, &dims, (cvxc_kktsolver_t *)0);
    cvxc_conelp_compute_start(&cp);
    cvxc_conelp_solve(&solution, &cp, &opts);
    print_solution(&solution);

    cvxc_conelp_release(&cp);
    cvxm_release(&A);
    cvxm_release(&b);
    cvxm_release(&G);

    int ok = solution.status == CVXC_STAT_OPTIMAL && (!base_test || solution.iterations == 9);
    printf("test_l1: %s\n", ok ? "OK" : "FAILED");

    exit(1 - ok);
}
